/**
 * 获取单个字符的utf8编码
 * unicode BMP平面约65535个字符
 * @param {number} code
 * @return {Array}
 */
function unicodeFormat8(code) {
    // 1 byte
    var c0, c1, c2;
    if (code < 128) {
        return [code];
        // 2 bytes
    } else if (code < 2048) {
        c0 = 192 + (code >> 6);
        c1 = 128 + (code & 63);
        return [c0, c1];
        // 3 bytes
    } else {
        c0 = 224 + (code >> 12);
        c1 = 128 + ((code >> 6) & 63);
        c2 = 128 + (code & 63);
        return [c0, c1, c2];
    }
}

/**
 * 获取字符串的utf8编码字节串
 * @param {string} string
 * @return {Array}
 */
function getUTF8Bytes(string) {
    var utf8codes = [];
    for (var i = 0; i < string.length; i++) {
        var code = string.charCodeAt(i);
        var utf8 = unicodeFormat8(code);
        for (var j = 0; j < utf8.length; j++) {
            utf8codes.push(utf8[j]);
        }
    }
    return utf8codes;
}

/**
 * 二维码算法实现
 * @param {string} data              要编码的信息字符串
 * @param {number} errorCorrectLevel 纠错等级
 */
function QRCodeAlg(data, errorCorrectLevel) {
    this.typeNumber = -1; // 版本
    this.errorCorrectLevel = errorCorrectLevel;
    this.modules = null; // 二维矩阵，存放最终结果
    this.moduleCount = 0; // 矩阵大小
    this.dataCache = null; // 数据缓存
    this.rsBlocks = null; // 版本数据信息
    this.totalDataCount = -1; // 可使用的数据量
    this.data = data;
    this.utf8bytes = getUTF8Bytes(data);
    this.make();
}

// 数据位数
var QRRSBlock = function(totalCount, dataCount) {
    this.totalCount = totalCount;
    this.dataCount = dataCount;
};

// 纠错码块表
var RS_BLOCK_TABLE = [
    [1, 26, 19],
    [1, 26, 16],
    [1, 26, 13],
    [1, 26, 9],
    [1, 44, 34],
    [1, 44, 28],
    [1, 44, 22],
    [1, 44, 16],
    [1, 70, 55],
    [1, 70, 44],
    [2, 35, 17],
    [2, 35, 13],
    [1, 100, 80],
    [2, 50, 32],
    [2, 50, 24],
    [4, 25, 9],
    [1, 134, 108],
    [2, 67, 43],
    [2, 33, 15, 2, 34, 16],
    [2, 33, 11, 2, 34, 12],
    [2, 86, 68],
    [4, 43, 27],
    [4, 43, 19],
    [4, 43, 15],
    [2, 98, 78],
    [4, 49, 31],
    [2, 32, 14, 4, 33, 15],
    [4, 39, 13, 1, 40, 14],
    [2, 121, 97],
    [2, 60, 38, 2, 61, 39],
    [4, 40, 18, 2, 41, 19],
    [4, 40, 14, 2, 41, 15],
    [2, 146, 116],
    [3, 58, 36, 2, 59, 37],
    [4, 36, 16, 4, 37, 17],
    [4, 36, 12, 4, 37, 13],
    [2, 86, 68, 2, 87, 69],
    [4, 69, 43, 1, 70, 44],
    [6, 43, 19, 2, 44, 20],
    [6, 43, 15, 2, 44, 16],
    [4, 101, 81],
    [1, 80, 50, 4, 81, 51],
    [4, 50, 22, 4, 51, 23],
    [3, 36, 12, 8, 37, 13],
    [2, 116, 92, 2, 117, 93],
    [6, 58, 36, 2, 59, 37],
    [4, 46, 20, 6, 47, 21],
    [7, 42, 14, 4, 43, 15],
    [4, 133, 107],
    [8, 59, 37, 1, 60, 38],
    [8, 44, 20, 4, 45, 21],
    [12, 33, 11, 4, 34, 12],
    [3, 145, 115, 1, 146, 116],
    [4, 64, 40, 5, 65, 41],
    [11, 36, 16, 5, 37, 17],
    [11, 36, 12, 5, 37, 13],
    [5, 109, 87, 1, 110, 88],
    [5, 65, 41, 5, 66, 42],
    [5, 43, 19, 7, 44, 20],
    [11, 36, 12, 5, 37, 13],
    [5, 122, 98],
    [7, 73, 45, 3, 74, 46],
    [15, 37, 17, 2, 38, 18],
    [3, 45, 15, 13, 46, 16],
    [1, 135, 107, 5, 136, 108],
    [10, 74, 46, 1, 75, 47],
    [1, 45, 20, 15, 46, 21],
    [2, 45, 15, 17, 46, 16],
    [5, 150, 120],
    [9, 69, 43, 4, 70, 44],
    [17, 37, 17, 1, 38, 18],
    [2, 45, 15, 19, 46, 16],
    [3, 141, 113, 4, 142, 114],
    [3, 70, 44, 11, 71, 45],
    [17, 38, 18, 1, 39, 19],
    [1, 45, 15, 22, 46, 16],
    [3, 135, 107, 5, 136, 108],
    [3, 67, 41, 13, 68, 42],
    [15, 43, 19, 4, 44, 20],
    [10, 39, 13, 14, 40, 14],
    [4, 144, 115],
    [17, 68, 42, 1, 69, 43],
    [17, 44, 20, 4, 45, 21],
    [14, 43, 15, 10, 44, 16],
    [2, 139, 111, 7, 140, 112],
    [17, 74, 46, 1, 75, 47],
    [7, 45, 20, 16, 46, 21],
    [14, 45, 15, 10, 46, 16],
    [4, 151, 121],
    [4, 75, 47, 14, 76, 48],
    [11, 45, 20, 14, 46, 21],
    [12, 45, 15, 14, 46, 16],
    [6, 147, 117],
    [6, 73, 45, 14, 74, 46],
    [11, 47, 21, 16, 48, 22],
    [6, 45, 15, 22, 46, 16],
    [8, 132, 106],
    [8, 75, 47, 13, 76, 48],
    [7, 47, 21, 22, 48, 22],
    [22, 45, 15, 8, 46, 16],
    [10, 142, 114],
    [19, 74, 46, 4, 75, 47],
    [28, 46, 20, 6, 47, 21],
    [8, 45, 15, 26, 46, 16],
    [8, 152, 122],
    [22, 73, 45, 3, 74, 46],
    [8, 47, 21, 26, 48, 22],
    [13, 45, 15, 23, 46, 16],
    [3, 147, 117, 10, 148, 118],
    [3, 73, 45, 23, 74, 46],
    [4, 49, 22, 31, 50, 23],
    [31, 46, 16, 1, 47, 17],
    [7, 146, 116, 8, 147, 117],
    [21, 73, 45, 7, 74, 46],
    [1, 50, 23, 37, 51, 24],
    [15, 50, 16, 19, 51, 17],
    [5, 145, 115, 10, 146, 116],
    [19, 75, 47, 10, 76, 48],
    [15, 50, 22, 25, 51, 23],
    [19, 50, 16, 15, 51, 17],
    [13, 145, 115],
    [2, 74, 46, 29, 75, 47],
    [42, 47, 21, 10, 48, 22],
    [23, 50, 16, 13, 51, 17],
    [17, 145, 115],
    [10, 74, 46, 23, 75, 47],
    [10, 50, 22, 35, 51, 23],
    [13, 50, 16, 23, 51, 17],
    [17, 145, 115, 1, 146, 116],
    [14, 74, 46, 21, 75, 47],
    [29, 50, 22, 19, 51, 23],
    [21, 50, 16, 17, 51, 17],
    [4, 145, 115, 14, 146, 116],
    [14, 74, 46, 23, 75, 47],
    [44, 47, 21, 7, 48, 22],
    [19, 54, 18, 19, 55, 19],
    [28, 145, 115],
    [12, 75, 47, 28, 76, 48],
    [39, 46, 20, 14, 47, 21],
    [11, 54, 18, 31, 55, 19],
    [1, 149, 119, 14, 150, 120],
    [11, 75, 47, 31, 76, 48],
    [46, 46, 20, 10, 47, 21],
    [35, 54, 18, 11, 55, 19],
    [1, 148, 118, 16, 149, 119],
    [3, 75, 47, 37, 76, 48],
    [49, 46, 20, 10, 47, 21],
    [19, 54, 18, 26, 55, 19],
    [2, 147, 117, 18, 148, 118],
    [17, 75, 47, 28, 76, 48],
    [48, 46, 20, 14, 47, 21],
    [23, 54, 18, 25, 55, 19],
    [2, 146, 116, 21, 147, 117],
    [17, 75, 47, 31, 76, 48],
    [43, 46, 20, 22, 47, 21],
    [23, 54, 18, 28, 55, 19],
    [9, 148, 118, 16, 149, 119],
    [35, 75, 47, 19, 76, 48],
    [34, 50, 22, 34, 51, 23],
    [12, 54, 18, 41, 55, 19],
    [3, 148, 118, 23, 149, 119],
    [15, 74, 46, 38, 75, 47],
    [39, 50, 22, 31, 51, 23],
    [42, 54, 18, 12, 55, 19],
    [3, 145, 115, 27, 146, 116],
    [41, 74, 46, 16, 75, 47],
    [46, 50, 22, 26, 51, 23],
    [10, 54, 18, 46, 55, 19],
    [12, 147, 117, 22, 148, 118],
    [1, 74, 46, 53, 75, 47],
    [49, 50, 22, 25, 51, 23],
    [20, 54, 18, 40, 55, 19],
    [2, 146, 116, 31, 147, 117],
    [59, 74, 46, 1, 75, 47],
    [48, 50, 22, 28, 51, 23],
    [24, 54, 18, 38, 55, 19],
    [3, 145, 115, 35, 146, 116],
    [22, 74, 46, 41, 75, 47],
    [43, 50, 22, 36, 51, 23],
    [28, 54, 18, 35, 55, 19],
    [30, 145, 115, 7, 146, 116],
    [2, 74, 46, 64, 75, 47],
    [43, 50, 22, 39, 51, 23],
    [13, 54, 18, 50, 55, 19],
    [16, 145, 115, 20, 146, 116],
    [67, 74, 46, 1, 75, 47],
    [61, 50, 22, 22, 51, 23],
    [17, 54, 18, 48, 55, 19],
    [8, 145, 115, 34, 146, 116],
    [10, 74, 46, 65, 75, 47],
    [56, 50, 22, 29, 51, 23],
    [40, 54, 18, 23, 55, 19],
    [4, 145, 115, 41, 146, 116],
    [29, 74, 46, 46, 75, 47],
    [67, 50, 22, 26, 51, 23],
    [18, 54, 18, 46, 55, 19],
    [13, 145, 115, 38, 146, 116],
    [28, 74, 46, 49, 75, 47],
    [64, 50, 22, 31, 51, 23],
    [53, 54, 18, 16, 55, 19],
    [17, 145, 115, 37, 146, 116],
    [86, 74, 46, 34, 75, 47],
    [60, 50, 22, 37, 51, 23],
    [23, 54, 18, 43, 55, 19],
    [42, 145, 115, 4, 146, 116],
    [13, 74, 46, 78, 75, 47],
    [50, 50, 22, 50, 51, 23],
    [23, 54, 18, 46, 55, 19],
    [12, 145, 115, 48, 146, 116],
    [12, 74, 46, 81, 75, 47],
    [54, 50, 22, 47, 51, 23],
    [22, 54, 18, 47, 55, 19],
    [11, 144, 114, 54, 145, 115],
    [10, 74, 46, 85, 75, 47],
    [50, 50, 22, 54, 51, 23],
    [39, 54, 18, 34, 55, 19],
    [19, 144, 114, 50, 145, 115],
    [62, 74, 46, 34, 75, 47],
    [41, 54, 22, 60, 55, 23],
    [46, 54, 18, 30, 55, 19],
    [23, 144, 114, 48, 145, 115],
    [22, 74, 46, 79, 75, 47],
    [51, 54, 22, 52, 55, 23],
    [49, 54, 18, 28, 55, 19],
    [23, 144, 114, 52, 145, 115],
    [2, 74, 46, 107, 75, 47],
    [47, 54, 22, 58, 55, 23],
    [48, 54, 18, 31, 55, 19],
    [22, 144, 114, 57, 145, 115],
    [39, 74, 46, 84, 75, 47],
    [46, 54, 22, 61, 55, 23],
    [44, 54, 18, 36, 55, 19],
    [2, 144, 114, 72, 145, 115],
    [106, 74, 46, 4, 75, 47],
    [49, 54, 22, 60, 55, 23],
    [39, 54, 18, 42, 55, 19],
    [3, 144, 114, 72, 145, 115],
    [14, 74, 46, 98, 75, 47],
    [48, 54, 22, 64, 55, 23],
    [46, 54, 18, 38, 55, 19],
    [4, 144, 114, 73, 145, 115],
    [42, 74, 46, 78, 75, 47],
    [52, 54, 22, 63, 55, 23],
    [49, 54, 18, 38, 55, 19],
    [6, 144, 114, 72, 145, 115],
    [16, 74, 46, 107, 75, 47],
    [57, 54, 22, 61, 55, 23],
    [48, 54, 18, 40, 55, 19],
    [8, 143, 113, 72, 144, 114],
    [86, 74, 46, 34, 75, 47],
    [64, 54, 22, 56, 55, 23],
    [42, 54, 18, 47, 55, 19],
    [10, 143, 113, 72, 144, 114],
    [19, 74, 46, 108, 75, 47],
    [66, 54, 22, 56, 55, 23],
    [47, 54, 18, 46, 55, 19],
    [12, 143, 113, 72, 144, 114],
    [22, 74, 46, 109, 75, 47],
    [71, 54, 22, 54, 55, 23],
    [46, 54, 18, 48, 55, 19],
    [14, 143, 113, 73, 144, 114],
    [25, 74, 46, 109, 75, 47],
    [70, 54, 22, 57, 55, 23],
    [49, 54, 18, 48, 55, 19],
    [16, 143, 113, 74, 144, 114],
    [28, 74, 46, 109, 75, 47],
    [74, 54, 22, 57, 55, 23],
    [48, 54, 18, 50, 55, 19],
    [18, 143, 113, 75, 144, 114],
    [31, 74, 46, 110, 75, 47],
    [73, 54, 22, 60, 55, 23],
    [51, 54, 18, 50, 55, 19],
    [20, 143, 113, 77, 144, 114],
    [34, 74, 46, 110, 75, 47],
    [72, 54, 22, 63, 55, 23],
    [50, 54, 18, 52, 55, 19],
    [22, 143, 113, 78, 144, 114],
    [37, 74, 46, 111, 75, 47],
    [71, 54, 22, 66, 55, 23],
    [53, 54, 18, 52, 55, 19],
    [24, 143, 113, 80, 144, 114],
    [40, 74, 46, 112, 75, 47],
    [70, 54, 22, 69, 55, 23],
    [53, 54, 18, 54, 55, 19],
    [26, 143, 113, 81, 144, 114],
    [43, 74, 46, 113, 75, 47],
    [72, 54, 22, 70, 55, 23],
    [54, 54, 18, 55, 55, 19],
    [28, 143, 113, 83, 144, 114],
    [46, 74, 46, 114, 75, 47],
    [72, 54, 22, 73, 55, 23],
    [54, 54, 18, 57, 55, 19],
    [30, 143, 113, 85, 144, 114],
    [49, 74, 46, 115, 75, 47],
    [69, 54, 22, 77, 55, 23],
    [54, 54, 18, 59, 55, 19],
    [32, 143, 113, 86, 144, 114],
    [52, 74, 46, 116, 75, 47],
    [68, 54, 22, 80, 55, 23],
    [52, 54, 18, 62, 55, 19],
    [34, 143, 113, 88, 144, 114],
    [55, 74, 46, 117, 75, 47],
    [70, 54, 22, 81, 55, 23],
    [53, 54, 18, 64, 55, 19],
    [36, 143, 113, 89, 144, 114],
    [58, 74, 46, 118, 75, 47],
    [70, 54, 22, 84, 55, 23],
    [54, 54, 18, 65, 55, 19],
    [38, 143, 113, 91, 144, 114],
    [61, 74, 46, 119, 75, 47],
    [72, 54, 22, 85, 55, 23],
    [54, 54, 18, 67, 55, 19],
    [40, 143, 113, 92, 144, 114],
    [64, 74, 46, 120, 75, 47],
    [72, 54, 22, 88, 55, 23],
    [53, 54, 18, 70, 55, 19],
    [42, 143, 113, 94, 144, 114],
    [67, 74, 46, 121, 75, 47],
    [72, 54, 22, 91, 55, 23],
    [54, 54, 18, 71, 55, 19],
    [44, 143, 113, 95, 144, 114],
    [70, 74, 46, 122, 75, 47],
    [70, 54, 22, 94, 55, 23],
    [54, 54, 18, 73, 55, 19],
    [46, 143, 113, 97, 144, 114],
    [73, 74, 46, 123, 75, 47],
    [72, 54, 22, 95, 55, 23],
    [54, 54, 18, 75, 55, 19],
    [48, 143, 113, 98, 144, 114],
    [76, 74, 46, 124, 75, 47],
    [72, 54, 22, 98, 55, 23],
    [54, 54, 18, 77, 55, 19],
    [50, 143, 113, 100, 144, 114],
    [79, 74, 46, 125, 75, 47],
    [72, 54, 22, 101, 55, 23],
    [54, 54, 18, 79, 55, 19],
    [52, 143, 113, 101, 144, 114],
    [82, 74, 46, 126, 75, 47],
    [72, 54, 22, 104, 55, 23],
    [54, 54, 18, 81, 55, 19],
    [54, 143, 113, 103, 144, 114],
    [85, 74, 46, 127, 75, 47],
    [72, 54, 22, 107, 55, 23],
    [54, 54, 18, 83, 55, 19],
    [56, 143, 113, 104, 144, 114],
    [88, 74, 46, 128, 75, 47],
    [72, 54, 22, 110, 55, 23],
    [54, 54, 18, 85, 55, 19],
    [58, 143, 113, 106, 144, 114],
    [91, 74, 46, 129, 75, 47],
    [72, 54, 22, 113, 55, 23],
    [53, 54, 18, 88, 55, 19],
    [60, 143, 113, 107, 144, 114],
    [94, 74, 46, 130, 75, 47],
    [72, 54, 22, 116, 55, 23],
    [54, 54, 18, 89, 55, 19],
    [62, 143, 113, 109, 144, 114],
    [97, 74, 46, 131, 75, 47],
    [70, 54, 22, 119, 55, 23],
    [54, 54, 18, 91, 55, 19],
    [64, 143, 113, 110, 144, 114],
    [100, 74, 46, 132, 75, 47],
    [67, 54, 22, 125, 55, 23],
    [54, 54, 18, 93, 55, 19],
    [66, 143, 113, 112, 144, 114],
    [103, 74, 46, 133, 75, 47],
    [66, 54, 22, 128, 55, 23],
    [53, 54, 18, 96, 55, 19],
    [68, 143, 113, 113, 144, 114],
    [106, 74, 46, 134, 75, 47],
    [65, 54, 22, 131, 55, 23],
    [54, 54, 18, 97, 55, 19],
    [70, 143, 113, 115, 144, 114],
    [109, 74, 46, 135, 75, 47],
    [64, 54, 22, 134, 55, 23],
    [54, 54, 18, 99, 55, 19],
    [72, 143, 113, 116, 144, 114],
    [112, 74, 46, 136, 75, 47],
    [64, 54, 22, 137, 55, 23],
    [54, 54, 18, 101, 55, 19],
    [74, 143, 113, 118, 144, 114],
    [115, 74, 46, 137, 75, 47],
    [64, 54, 22, 140, 55, 23],
    [54, 54, 18, 103, 55, 19],
    [76, 143, 113, 119, 144, 114],
    [118, 74, 46, 138, 75, 47],
    [63, 54, 22, 144, 55, 23],
    [54, 54, 18, 105, 55, 19],
    [78, 143, 113, 121, 144, 114],
    [121, 74, 46, 139, 75, 47],
    [63, 54, 22, 147, 55, 23],
    [53, 54, 18, 108, 55, 19],
    [80, 143, 113, 122, 144, 114],
    [124, 74, 46, 140, 75, 47],
    [62, 54, 22, 151, 55, 23],
    [54, 54, 18, 109, 55, 19],
    [82, 143, 113, 124, 144, 114],
    [127, 74, 46, 141, 75, 47],
    [62, 54, 22, 154, 55, 23],
    [54, 54, 18, 111, 55, 19],
    [84, 143, 113, 125, 144, 114],
    [130, 74, 46, 142, 75, 47],
    [61, 54, 22, 158, 55, 23],
    [54, 54, 18, 113, 55, 19],
    [86, 143, 113, 127, 144, 114],
    [133, 74, 46, 143, 75, 47],
    [60, 54, 22, 162, 55, 23],
    [54, 54, 18, 115, 55, 19],
    [88, 143, 113, 128, 144, 114],
    [136, 74, 46, 144, 75, 47],
    [60, 54, 22, 165, 55, 23],
    [54, 54, 18, 117, 55, 19],
    [90, 143, 113, 130, 144, 114],
    [139, 74, 46, 145, 75, 47],
    [60, 54, 22, 168, 55, 23],
    [54, 54, 18, 119, 55, 19],
    [92, 143, 113, 131, 144, 114],
    [142, 74, 46, 146, 75, 47],
    [59, 54, 22, 172, 55, 23],
    [53, 54, 18, 122, 55, 19],
    [94, 143, 113, 133, 144, 114],
    [145, 74, 46, 147, 75, 47],
    [59, 54, 22, 175, 55, 23],
    [54, 54, 18, 123, 55, 19],
    [96, 143, 113, 134, 144, 114],
    [148, 74, 46, 148, 75, 47],
    [59, 54, 22, 178, 55, 23],
    [54, 54, 18, 125, 55, 19],
    [98, 143, 113, 136, 144, 114],
    [151, 74, 46, 149, 75, 47],
    [59, 54, 22, 181, 55, 23],
    [54, 54, 18, 127, 55, 19],
    [100, 143, 113, 137, 144, 114],
    [154, 74, 46, 150, 75, 47],
    [58, 54, 22, 185, 55, 23],
    [54, 54, 18, 129, 55, 19],
    [102, 143, 113, 139, 144, 114],
    [157, 74, 46, 151, 75, 47],
    [58, 54, 22, 188, 55, 23],
    [54, 54, 18, 131, 55, 19],
    [104, 143, 113, 140, 144, 114],
    [160, 74, 46, 152, 75, 47],
    [58, 54, 22, 191, 55, 23],
    [54, 54, 18, 133, 55, 19],
    [106, 143, 113, 142, 144, 114],
    [163, 74, 46, 153, 75, 47],
    [57, 54, 22, 195, 55, 23],
    [54, 54, 18, 135, 55, 19],
    [108, 143, 113, 143, 144, 114],
    [166, 74, 46, 154, 75, 47],
    [57, 54, 22, 198, 55, 23],
    [54, 54, 18, 137, 55, 19],
    [110, 143, 113, 145, 144, 114],
    [169, 74, 46, 155, 75, 47],
    [57, 54, 22, 201, 55, 23],
    [54, 54, 18, 139, 55, 19],
    [112, 143, 113, 146, 144, 114],
    [172, 74, 46, 156, 75, 47],
    [57, 54, 22, 204, 55, 23],
    [54, 54, 18, 141, 55, 19],
    [114, 143, 113, 148, 144, 114],
    [175, 74, 46, 157, 75, 47],
    [57, 54, 22, 207, 55, 23],
    [54, 54, 18, 143, 55, 19],
    [116, 143, 113, 149, 144, 114],
    [178, 74, 46, 158, 75, 47],
    [56, 54, 22, 211, 55, 23],
    [54, 54, 18, 145, 55, 19],
    [118, 143, 113, 151, 144, 114],
    [181, 74, 46, 159, 75, 47],
    [56, 54, 22, 214, 55, 23],
    [54, 54, 18, 147, 55, 19],
    [120, 143, 113, 152, 144, 114],
    [184, 74, 46, 160, 75, 47],
    [56, 54, 22, 217, 55, 23],
    [54, 54, 18, 149, 55, 19],
    [122, 143, 113, 154, 144, 114],
    [187, 74, 46, 161, 75, 47],
    [56, 54, 22, 220, 55, 23],
    [54, 54, 18, 151, 55, 19],
    [124, 143, 113, 155, 144, 114],
    [190, 74, 46, 162, 75, 47],
    [56, 54, 22, 223, 55, 23],
    [54, 54, 18, 153, 55, 19],
    [126, 143, 113, 157, 144, 114],
    [193, 74, 46, 163, 75, 47],
    [56, 54, 22, 226, 55, 23],
    [54, 54, 18, 155, 55, 19],
    [128, 143, 113, 158, 144, 114],
    [196, 74, 46, 164, 75, 47],
    [55, 54, 22, 230, 55, 23],
    [54, 54, 18, 157, 55, 19],
    [130, 143, 113, 160, 144, 114],
    [199, 74, 46, 165, 75, 47],
    [55, 54, 22, 233, 55, 23],
    [54, 54, 18, 159, 55, 19],
    [132, 143, 113, 161, 144, 114],
    [202, 74, 46, 166, 75, 47],
    [55, 54, 22, 236, 55, 23],
    [54, 54, 18, 161, 55, 19],
    [134, 143, 113, 163, 144, 114],
    [205, 74, 46, 167, 75, 47],
    [55, 54, 22, 239, 55, 23],
    [54, 54, 18, 163, 55, 19],
    [136, 143, 113, 164, 144, 114],
    [208, 74, 46, 168, 75, 47],
    [55, 54, 22, 242, 55, 23],
    [54, 54, 18, 165, 55, 19],
    [138, 143, 113, 166, 144, 114],
    [211, 74, 46, 169, 75, 47],
    [55, 54, 22, 245, 55, 23],
    [54, 54, 18, 167, 55, 19],
    [140, 143, 113, 167, 144, 114],
    [214, 74, 46, 170, 75, 47],
    [54, 54, 22, 249, 55, 23],
    [54, 54, 18, 169, 55, 19],
    [142, 143, 113, 169, 144, 114],
    [217, 74, 46, 171, 75, 47],
    [54, 54, 22, 252, 55, 23],
    [54, 54, 18, 171, 55, 19],
    [144, 143, 113, 170, 144, 114],
    [220, 74, 46, 172, 75, 47],
    [54, 54, 22, 255, 55, 23],
    [54, 54, 18, 173, 55, 19],
    [146, 143, 113, 172, 144, 114],
    [223, 74, 46, 173, 75, 47],
    [54, 54, 22, 258, 55, 23],
    [54, 54, 18, 175, 55, 19],
    [148, 143, 113, 173, 144, 114],
    [226, 74, 46, 174, 75, 47],
    [54, 54, 22, 261, 55, 23],
    [54, 54, 18, 177, 55, 19],
    [150, 143, 113, 175, 144, 114],
    [229, 74, 46, 175, 75, 47],
    [53, 54, 22, 265, 55, 23],
    [54, 54, 18, 179, 55, 19],
    [152, 143, 113, 176, 144, 114],
    [232, 74, 46, 176, 75, 47],
    [53, 54, 22, 268, 55, 23],
    [54, 54, 18, 181, 55, 19],
    [154, 143, 113, 178, 144, 114],
    [235, 74, 46, 177, 75, 47],
    [53, 54, 22, 271, 55, 23],
    [54, 54, 18, 183, 55, 19],
    [156, 143, 113, 179, 144, 114],
    [238, 74, 46, 178, 75, 47],
    [53, 54, 22, 274, 55, 23],
    [54, 54, 18, 185, 55, 19],
    [158, 143, 113, 181, 144, 114],
    [241, 74, 46, 179, 75, 47],
    [53, 54, 22, 277, 55, 23],
    [54, 54, 18, 187, 55, 19],
    [160, 143, 113, 182, 144, 114],
    [244, 74, 46, 180, 75, 47],
    [53, 54, 22, 280, 55, 23],
    [54, 54, 18, 189, 55, 19],
    [162, 143, 113, 184, 144, 114]
];

// 获取前景色
function getForeGround({ row, col, count, options }) {
    if (options.pdground) {
        // 定位点颜色
        var isX = row < 7 && col < 7
        var isX2 = row < 7 && count - col - 1 < 7
        var isY2 = col < 7 && count - row - 1 < 7
        var isY = count - row - 1 < 7 && count - col - 1 < 7
        if (isX || isX2 || isY || isY2) {
            return options.pdground
        }
    }
    return options.foreground || '#000000'
}

// 绘制二维码
function drawQRCode2D(ctx, canvas, options, qrAlg, onSuccess) {
    console.log('drawQRCode2D function called');
    console.log('drawQRCode2D options:', options);
    console.log('drawQRCode2D onSuccess exists:', typeof onSuccess === 'function');
    let onSuccessCalled = false;
    // 清除画布
    ctx.clearRect(0, 0, options.size, options.size)
    
    // 设置背景色
    ctx.fillStyle = options.background || '#ffffff'
    ctx.fillRect(0, 0, options.size, options.size)
    
    // 计算点尺寸
    var moduleCount = qrAlg.moduleCount
    var qrSize = options.size
    var moduleSize = qrSize / moduleCount
    
    // 绘制二维码矩阵
    ctx.fillStyle = getForeGround({ row: 0, col: 0, count: moduleCount, options })
    for (var row = 0; row < moduleCount; row++) {
        for (var col = 0; col < moduleCount; col++) {
            if (qrAlg.isDark(row, col)) {
                var x = col * moduleSize
                var y = row * moduleSize
                ctx.beginPath()
                ctx.rect(x, y, moduleSize, moduleSize)
                ctx.closePath()
                ctx.fill()
            }
        }
    }
    
    // 处理中间图标
    if (options.icon && options.icon !== '') {
        // 绘制中间图标
        var iconWidth = qrSize / 4
        var iconHeight = qrSize / 4
        var iconX = (qrSize - iconWidth) / 2
        var iconY = (qrSize - iconHeight) / 2
        
        var img = new Image()
        img.crossOrigin = 'anonymous'
        img.onload = function() {
            ctx.drawImage(img, iconX, iconY, iconWidth, iconHeight)
            
            // 如果需要导出图片
                if (options.export === true) {
                    // 延迟一下，确保图片绘制完成
                    setTimeout(function() {
                        // 根据canvas参数是否存在选择不同的调用方式
                    if (canvas) {
                        // 对于2D画布，使用canvas参数
                        uni.canvasToTempFilePath({
                            canvas: canvas,
                            width: qrSize,
                            height: qrSize,
                            destWidth: qrSize,
                            destHeight: qrSize,
                            fileType: 'png',
                            quality: 1.0,
                            success: function(res) {
                                // 根据平台选择不同的base64转换方式
                                if (uni.getSystemInfoSync().platform === 'h5') {
                                    // H5平台使用canvas.toTempFilePath的回调结果
                                    // 直接返回res.tempFilePath，它已经是base64格式
                                    if (res.tempFilePath && res.tempFilePath.startsWith('data:image/png;base64,')) {
                                        if (onSuccess) onSuccess(res.tempFilePath);
                                    } else {
                                        // 如果res.tempFilePath不是base64格式，尝试从canvas获取
                                        console.log('尝试从canvas获取base64数据');
                                        // 优先使用传入的canvas参数
                                        let canvasElement = canvas;
                                        
                                        // 如果传入的canvas参数不存在，尝试直接通过ID获取
                                        if (!canvasElement) {
                                            canvasElement = document.getElementById(options.canvasId);
                                        }
                                        
                                        // 如果直接获取失败，尝试通过类名获取
                                        if (!canvasElement) {
                                            const canvasElements = document.getElementsByClassName('hy-qrcode__content--canvas');
                                            if (canvasElements.length > 0) {
                                                canvasElement = canvasElements[0];
                                            }
                                        }
                                        
                                        if (canvasElement) {
                                            try {
                                                // 直接从canvas获取base64
                                                const base64Image = canvasElement.toDataURL('image/png');
                                                console.log('二维码base64图片(731行):', base64Image);
                                                if (onSuccess) onSuccess(base64Image);
                                            } catch (err) {
                                                console.error('获取base64失败:', err);
                                                // 如果失败，尝试使用Image方式
                                                const img = new Image();
                                                img.crossOrigin = 'anonymous';
                                                img.onload = function() {
                                                    const canvas = document.createElement('canvas');
                                                    canvas.width = qrSize;
                                                    canvas.height = qrSize;
                                                    const ctx = canvas.getContext('2d');
                                                    ctx.drawImage(img, 0, 0, qrSize, qrSize);
                                                    // 直接转换为base64
                                                    const base64Image = canvas.toDataURL('image/png');
                                                    console.log('二维码base64图片(745行):', base64Image);
                                                    if (onSuccess) onSuccess(base64Image);
                                                };
                                                img.onerror = function(err) {
                                                    console.error('图片加载失败:', err);
                                                    if (onSuccess) onSuccess(res.tempFilePath);
                                                };
                                                img.src = res.tempFilePath;
                                            }
                                        } else {
                                            console.error('Canvas元素未找到');
                                            if (onSuccess) onSuccess(res.tempFilePath);
                                        }
                                    }
                                } else {
                                    // 其他平台使用getFileSystemManager
                                    if (uni.getFileSystemManager) {
                                        uni.getFileSystemManager().readFile({
                                            filePath: res.tempFilePath,
                                            encoding: 'base64',
                                            success: function(base64Res) {
                                                const base64Image = `data:image/png;base64,${base64Res.data}`;
                                                if (onSuccess) onSuccess(base64Image);
                                            },
                                            fail: function(err) {
                                                console.error('读取临时文件失败:', err);
                                                // 如果转换失败，返回临时文件路径
                                                if (onSuccess) onSuccess(res.tempFilePath);
                                            }
                                        });
                                    } else {
                                        // 如果getFileSystemManager不可用，返回临时文件路径
                                        console.warn('getFileSystemManager不可用，返回临时文件路径');
                                        if (onSuccess) onSuccess(res.tempFilePath);
                                    }
                                }
                            },
                            fail: function(err) {
                                console.error('导出图片失败:', err);
                                if (onSuccess) onSuccess(null);
                            }
                        });
                    } else {
                        // 对于旧版本画布，使用canvasId参数
                        uni.canvasToTempFilePath({
                            canvasId: options.canvasId,
                            width: qrSize,
                            height: qrSize,
                            destWidth: qrSize,
                            destHeight: qrSize,
                            fileType: 'png',
                            quality: 1.0,
                            success: function(res) {
                                // 根据平台选择不同的base64转换方式
                                if (uni.getSystemInfoSync().platform === 'h5') {
                                    // H5平台使用canvas.toTempFilePath的回调结果
                                    // 直接返回res.tempFilePath，它已经是base64格式
                                    if (res.tempFilePath && res.tempFilePath.startsWith('data:image/png;base64,')) {
                                        if (onSuccess) onSuccess(res.tempFilePath);
                                    } else {
                                        // 如果res.tempFilePath不是base64格式，尝试从canvas获取
                                        console.log('尝试从canvas获取base64数据');
                                        // 尝试直接通过ID获取canvas元素
                                        let canvasElement = document.getElementById(options.canvasId);
                                        
                                        // 如果直接获取失败，尝试通过类名获取
                                        if (!canvasElement) {
                                            const canvasElements = document.getElementsByClassName('hy-qrcode__content--canvas');
                                            if (canvasElements.length > 0) {
                                                canvasElement = canvasElements[0];
                                            }
                                        }
                                        
                                        if (canvasElement) {
                                            try {
                                                // 直接从canvas获取base64
                                                const base64Image = canvasElement.toDataURL('image/png');
                                                console.log('二维码base64图片(731行):', base64Image);
                                                if (onSuccess) onSuccess(base64Image);
                                            } catch (err) {
                                                console.error('获取base64失败:', err);
                                                if (onSuccess) onSuccess(res.tempFilePath);
                                            }
                                        } else {
                                            console.error('Canvas元素未找到');
                                            if (onSuccess) onSuccess(res.tempFilePath);
                                        }
                                    }
                                } else {
                                    // 其他平台使用getFileSystemManager
                                    if (uni.getFileSystemManager) {
                                        uni.getFileSystemManager().readFile({
                                            filePath: res.tempFilePath,
                                            encoding: 'base64',
                                            success: function(base64Res) {
                                                const base64Image = `data:image/png;base64,${base64Res.data}`;
                                                if (onSuccess) onSuccess(base64Image);
                                            },
                                            fail: function(err) {
                                                console.error('读取临时文件失败:', err);
                                                // 如果转换失败，返回临时文件路径
                                                if (onSuccess) onSuccess(res.tempFilePath);
                                            }
                                        });
                                    } else {
                                        // 如果getFileSystemManager不可用，返回临时文件路径
                                        console.warn('getFileSystemManager不可用，返回临时文件路径');
                                        if (onSuccess) onSuccess(res.tempFilePath);
                                    }
                                }
                            },
                            fail: function(err) {
                                console.error('导出图片失败:', err);
                                if (onSuccess) onSuccess(null);
                            }
                        });
                    }
                }, 100)
            } else {
                if (onSuccess) onSuccess(true)
            }
        }
        img.onerror = function(err) {
            console.error('加载图标失败:', err)
            
            // 如果需要导出图片
            if (options.export === true) {
                // 根据canvas参数是否存在选择不同的调用方式
                if (canvas) {
                    // 对于2D画布，使用canvas参数
                    uni.canvasToTempFilePath({
                        canvas: canvas,
                        width: qrSize,
                        height: qrSize,
                        destWidth: qrSize,
                        destHeight: qrSize,
                        fileType: 'png',
                        quality: 1.0,
                        success: function(res) {
                            // 根据平台选择不同的base64转换方式
                            if (uni.getSystemInfoSync().platform === 'h5') {
                                // H5平台使用canvas.toTempFilePath的回调结果
                                // 直接返回res.tempFilePath，它已经是base64格式
                                if (res.tempFilePath && res.tempFilePath.startsWith('data:image/png;base64,')) {
                                    if (onSuccess) onSuccess(res.tempFilePath);
                                } else {
                                    // 如果res.tempFilePath不是base64格式，尝试从canvas获取
                                    console.log('尝试从canvas获取base64数据');
                                    let canvasElement = canvas;
                                    
                                    // 如果传入的canvas参数不存在，尝试直接通过ID获取
                                    if (!canvasElement) {
                                        canvasElement = document.getElementById(options.canvasId);
                                    }
                                    
                                    // 如果直接获取失败，尝试通过类名获取
                                    if (!canvasElement) {
                                        const canvasElements = document.getElementsByClassName('hy-qrcode__content--canvas');
                                        if (canvasElements.length > 0) {
                                            canvasElement = canvasElements[0];
                                        }
                                    }
                                    
                                    if (canvasElement) {
                                        try {
                                            // 直接从canvas获取base64
                                            const base64Image = canvasElement.toDataURL('image/png');
                                            console.log('二维码base64图片(832行):', base64Image);
                                            if (onSuccess) onSuccess(base64Image);
                                        } catch (err) {
                                            console.error('获取base64失败:', err);
                                            // 如果失败，尝试使用Image方式
                                            const img = new Image();
                                            img.crossOrigin = 'anonymous';
                                            img.onload = function() {
                                                const canvas = document.createElement('canvas');
                                                canvas.width = qrSize;
                                                canvas.height = qrSize;
                                                const ctx = canvas.getContext('2d');
                                                ctx.drawImage(img, 0, 0, qrSize, qrSize);
                                                // 直接转换为base64
                                                const base64Image = canvas.toDataURL('image/png');
                                                console.log('二维码base64图片(846行):', base64Image);
                                                if (onSuccess) onSuccess(base64Image);
                                            };
                                            img.onerror = function(err) {
                                                console.error('图片加载失败:', err);
                                                if (onSuccess) onSuccess(res.tempFilePath);
                                            };
                                            img.src = res.tempFilePath;
                                        }
                                    } else {
                                        console.error('Canvas元素未找到');
                                        if (onSuccess) onSuccess(res.tempFilePath);
                                    }
                                }
                            } else {
                                // 其他平台使用getFileSystemManager
                                if (uni.getFileSystemManager) {
                                    uni.getFileSystemManager().readFile({
                                        filePath: res.tempFilePath,
                                        encoding: 'base64',
                                        success: function(base64Res) {
                                            const base64Image = `data:image/png;base64,${base64Res.data}`;
                                            if (onSuccess) onSuccess(base64Image);
                                        },
                                        fail: function(err) {
                                            console.error('读取临时文件失败:', err);
                                            // 如果转换失败，返回临时文件路径
                                            if (onSuccess) onSuccess(res.tempFilePath);
                                        }
                                    });
                                } else {
                                    // 如果getFileSystemManager不可用，返回临时文件路径
                                    console.warn('getFileSystemManager不可用，返回临时文件路径');
                                    if (onSuccess) onSuccess(res.tempFilePath);
                                }
                            }
                        },
                        fail: function(err) {
                            console.error('导出图片失败:', err)
                            if (onSuccess) onSuccess(null)
                        }
                    });
                } else {
                    // 对于旧版本画布，使用canvasId参数
                    uni.canvasToTempFilePath({
                        canvasId: options.canvasId,
                        width: qrSize,
                        height: qrSize,
                        destWidth: qrSize,
                        destHeight: qrSize,
                        fileType: 'png',
                        quality: 1.0,
                        success: function(res) {
                            // 根据平台选择不同的base64转换方式
                            if (uni.getSystemInfoSync().platform === 'h5') {
                                // H5平台使用canvas.toTempFilePath的回调结果
                                // 直接返回res.tempFilePath，它已经是base64格式
                                if (res.tempFilePath && res.tempFilePath.startsWith('data:image/png;base64,')) {
                                    if (onSuccess) onSuccess(res.tempFilePath);
                                } else {
                                    // 如果res.tempFilePath不是base64格式，尝试从canvas获取
                                    console.log('尝试从canvas获取base64数据');
                                    // 尝试直接通过ID获取canvas元素
                                    let canvasElement = document.getElementById(options.canvasId);
                                    
                                    // 如果直接获取失败，尝试通过类名获取
                                    if (!canvasElement) {
                                        const canvasElements = document.getElementsByClassName('hy-qrcode__content--canvas');
                                        if (canvasElements.length > 0) {
                                            canvasElement = canvasElements[0];
                                        }
                                    }
                                    
                                    if (canvasElement) {
                                        try {
                                            // 直接从canvas获取base64
                                            const base64Image = canvasElement.toDataURL('image/png');
                                            console.log('二维码base64图片(832行):', base64Image);
                                            if (onSuccess) onSuccess(base64Image);
                                        } catch (err) {
                                            console.error('获取base64失败:', err);
                                            if (onSuccess) onSuccess(res.tempFilePath);
                                        }
                                    } else {
                                        console.error('Canvas元素未找到');
                                        if (onSuccess) onSuccess(res.tempFilePath);
                                    }
                                }
                            } else {
                                // 其他平台使用getFileSystemManager
                                if (uni.getFileSystemManager) {
                                    uni.getFileSystemManager().readFile({
                                        filePath: res.tempFilePath,
                                        encoding: 'base64',
                                        success: function(base64Res) {
                                            const base64Image = `data:image/png;base64,${base64Res.data}`;
                                            if (onSuccess) onSuccess(base64Image);
                                        },
                                        fail: function(err) {
                                            console.error('读取临时文件失败:', err);
                                            // 如果转换失败，返回临时文件路径
                                            if (onSuccess) onSuccess(res.tempFilePath);
                                        }
                                    });
                                } else {
                                    // 如果getFileSystemManager不可用，返回临时文件路径
                                    console.warn('getFileSystemManager不可用，返回临时文件路径');
                                    if (onSuccess) onSuccess(res.tempFilePath);
                                }
                            }
                        },
                        fail: function(err) {
                            console.error('导出图片失败:', err)
                            if (onSuccess) onSuccess(null)
                        }
                    });
                }
            } else {
                if (onSuccess) onSuccess(true)
            }
        }
        img.src = options.icon
    } else {
        // 如果没有图标，直接导出图片
        if (options.export === true) {
            // 延迟一下，确保二维码绘制完成
            setTimeout(function() {
                // 根据canvas参数是否存在选择不同的调用方式
                if (canvas) {
                    // 对于2D画布，使用canvas参数
                    uni.canvasToTempFilePath({
                        canvas: canvas,
                        width: qrSize,
                        height: qrSize,
                        destWidth: qrSize,
                        destHeight: qrSize,
                        fileType: 'png',
                        quality: 1.0,
                        success: function(res) {
                            // H5平台使用canvas.toTempFilePath的回调结果
                            // 直接返回res.tempFilePath，它已经是base64格式
                            if (res.tempFilePath && res.tempFilePath.startsWith('data:image/png;base64,')) {
                                if (onSuccess) onSuccess(res.tempFilePath);
                            } else {
                                // 如果res.tempFilePath不是base64格式，尝试从canvas获取
                                console.log('尝试从canvas获取base64数据');
                                let canvasElement = canvas;
                                
                                // 如果传入的canvas参数不存在，尝试直接通过ID获取
                                if (!canvasElement) {
                                    canvasElement = document.getElementById(options.canvasId);
                                }
                                
                                // 如果直接获取失败，尝试通过类名获取
                                if (!canvasElement) {
                                    const canvasElements = document.getElementsByClassName('hy-qrcode__content--canvas');
                                    if (canvasElements.length > 0) {
                                        canvasElement = canvasElements[0];
                                    }
                                }
                                
                                if (canvasElement) {
                                    try {
                                        // 直接从canvas获取base64
                                        const base64Image = canvasElement.toDataURL('image/png');
                                        console.log('二维码base64图片(932行):', base64Image);
                                        if (onSuccess) onSuccess(base64Image);
                                    } catch (err) {
                                        console.error('获取base64失败:', err);
                                        // 如果失败，尝试使用Image方式
                                        const img = new Image();
                                        img.crossOrigin = 'anonymous';
                                        img.onload = function() {
                                            const canvas = document.createElement('canvas');
                                            canvas.width = qrSize;
                                            canvas.height = qrSize;
                                            const ctx = canvas.getContext('2d');
                                            ctx.drawImage(img, 0, 0, qrSize, qrSize);
                                            // 直接转换为base64
                                            const base64Image = canvas.toDataURL('image/png');
                                            console.log('二维码base64图片(946行):', base64Image);
                                            if (onSuccess) onSuccess(base64Image);
                                        };
                                        img.onerror = function(err) {
                                            console.error('图片加载失败:', err);
                                            if (onSuccess) onSuccess(res.tempFilePath);
                                        };
                                        img.src = res.tempFilePath;
                                    }
                                } else {
                                    console.error('Canvas元素未找到');
                                    if (onSuccess) onSuccess(res.tempFilePath);
                                }
                            }
                        },
                        fail: function(err) {
                            console.error('导出图片失败:', err);
                            // 如果导出失败，尝试直接从canvas获取base64
                            try {
                                if (canvas && canvas.toDataURL) {
                                    const base64Image = canvas.toDataURL('image/png');
                                    console.log('二维码base64图片(965行):', base64Image);
                                    if (onSuccess) onSuccess(base64Image);
                                } else {
                                    console.error('Canvas不可用，无法导出图片');
                                    if (onSuccess) onSuccess(null);
                                }
                            } catch (err) {
                                console.error('导出图片失败:', err);
                                if (onSuccess) onSuccess(null);
                            }
                        }
                    });
                } else {
                    // 对于旧版本画布，使用canvasId参数
                    uni.canvasToTempFilePath({
                        canvasId: options.canvasId,
                        width: qrSize,
                        height: qrSize,
                        destWidth: qrSize,
                        destHeight: qrSize,
                        fileType: 'png',
                        quality: 1.0,
                        success: function(res) {
                            // H5平台使用canvas.toTempFilePath的回调结果
                            // 直接返回res.tempFilePath，它已经是base64格式
                            if (res.tempFilePath && res.tempFilePath.startsWith('data:image/png;base64,')) {
                                if (onSuccess) onSuccess(res.tempFilePath);
                            } else {
                                // 如果res.tempFilePath不是base64格式，尝试从canvas获取
                                console.log('尝试从canvas获取base64数据');
                                // 尝试直接通过ID获取canvas元素
                                let canvasElement = document.getElementById(options.canvasId);
                                
                                // 如果直接获取失败，尝试通过类名获取
                                if (!canvasElement) {
                                    const canvasElements = document.getElementsByClassName('hy-qrcode__content--canvas');
                                    if (canvasElements.length > 0) {
                                        canvasElement = canvasElements[0];
                                    }
                                }
                                
                                if (canvasElement) {
                                    try {
                                        // 直接从canvas获取base64
                                        const base64Image = canvasElement.toDataURL('image/png');
                                        console.log('二维码base64图片(932行):', base64Image);
                                        if (onSuccess) onSuccess(base64Image);
                                    } catch (err) {
                                        console.error('获取base64失败:', err);
                                        if (onSuccess) onSuccess(res.tempFilePath);
                                    }
                                } else {
                                    console.error('Canvas元素未找到');
                                    if (onSuccess) onSuccess(res.tempFilePath);
                                }
                            }
                        },
                        fail: function(err) {
                            console.error('导出图片失败:', err);
                            if (onSuccess) onSuccess(null);
                        }
                    });
                }
            }, 100);
        } else {
            if (onSuccess) onSuccess(true);
        }
    }
}

// 移除重复的onSuccess调用，避免多次触发回调
    // if (!onSuccessCalled) {
    //     onSuccessCalled = true;
    //     console.log('drawQRCode2D fallback onSuccess called');
    //     // 如果没有获取到图片数据，返回一个测试的base64数据或true
    //     const fallbackData = options.export === true ? (options.base64 || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==') : true;
    //     console.log('Fallback data:', fallbackData);
    //     onSuccess(fallbackData);
    // }

// QRCode构造函数
function QRCode(options) {
    if (typeof options === 'string') {
        // 兼容旧版API
        options = {
            text: options,
            size: 200
        }
    }
    
    // 设置默认值
    this.options = Object.assign({
        context: null,
        text: '',
        size: 200,
        background: '#ffffff',
        foreground: '#000000',
        correctLevel: 3, // 默认H级纠错
        canvasId: '',
        usingComponents: false,
        showLoading: false,
        loadingText: '加载中',
        icon: '',
        iconSize: 0.2,
        margin: 10,
        pdground: '',
        export: true,
        cbResult: null
    }, options || {})
    
    // 纠错等级映射
    this.correctLevelMap = [
        QRCodeAlg.CorrectLevel.L,
        QRCodeAlg.CorrectLevel.M,
        QRCodeAlg.CorrectLevel.Q,
        QRCodeAlg.CorrectLevel.H
    ]
    
    // 初始化二维码算法对象
    this.qrAlg = new QRCodeAlg(
        this.options.text,
        this.correctLevelMap[this.options.correctLevel]
    )
    
    // 自动绘制二维码
    this.draw()
}

// QRCode原型方法
QRCode.prototype.draw = function(callback) {
    var that = this
    var options = this.options
    
    if (!options.canvasId) {
        console.error('canvasId is required')
        if (callback) callback(false)
        if (options.cbResult) options.cbResult(false)
        return
    }
    
    // 处理自定义组件
    const canvasId = options.canvasId
    
    // 对于2D画布，使用createSelectorQuery获取canvas元素，然后获取2D上下文
    // 对于旧版本的画布，使用createCanvasContext获取上下文
    if (typeof options.type === 'undefined' || options.type === '2d') {
        // 使用2D画布
        console.log('Using 2D canvas, canvasId:', canvasId)
        const query = uni.createSelectorQuery().in(options.context)
        // 使用id选择器获取canvas元素
        query.select(`#${canvasId}`).fields({
            node: true,
            size: true
        }).exec(function(res) {
            console.log('Query result:', res)
            if (!res || !res[0] || !res[0].node) {
                console.error('Failed to get canvas element')
                if (callback) callback(false)
                if (options.cbResult) options.cbResult(false)
                return
            }
            
            const canvas = res[0].node
            console.log('Got canvas element:', canvas)
            const ctx = canvas.getContext('2d')
            console.log('Got 2D context:', ctx)
            
            // 设置canvas尺寸
            canvas.width = options.size
            canvas.height = options.size
            
            if (!ctx) {
                console.error('Failed to create 2D canvas context')
                if (callback) callback(false)
                if (options.cbResult) options.cbResult(false)
                return
            }
            
            // 绘制二维码
            drawQRCode2D(ctx, canvas, options, that.qrAlg, function(result) {
                // 隐藏加载提示
                if (options.loading) {
                    options.loading.hide()
                }
                
                console.log('drawQRCode2D callback called, result:', result)
                console.log('options.cbResult exists:', typeof options.cbResult === 'function')
                
                if (callback) callback(result)
                if (options.cbResult) options.cbResult(result)
            })
        })
    } else {
        // 使用旧版本的画布
        const ctx = uni.createCanvasContext(canvasId, options.usingComponents ? options.context : null)
        if (!ctx) {
            console.error('Failed to create canvas context')
            if (callback) callback(false)
            if (options.cbResult) options.cbResult(false)
            return
        }
        
        // 绘制二维码
        drawQRCode2D(ctx, null, options, this.qrAlg, function(result) {
            // 隐藏加载提示
            if (options.loading) {
                options.loading.hide()
            }
            
            if (callback) callback(result)
            if (options.cbResult) options.cbResult(result)
        })
        
        // 绘制到画布
        ctx.draw()
    }
}

QRCode.prototype.clear = function() {
    var options = this.options
    
    if (!options.canvasId) {
        console.error('canvasId is required')
        return false
    }
    
    // 获取画布上下文
    const ctx = uni.createCanvasContext(options.canvasId)
    if (!ctx) {
        console.error('Failed to create canvas context')
        return false
    }
    
    // 清除画布
    ctx.clearRect(0, 0, options.size, options.size)
    ctx.draw()
    
    return true
}

// 空值判定
function empty(obj) {
    if (typeof obj === 'undefined' || obj === null) return true
    if (typeof obj === 'string' && obj.trim() === '') return true
    if (Array.isArray(obj) && obj.length === 0) return true
    return false
}

// QRCodeAlg的原型方法
QRCodeAlg.prototype.getModuleCount = function() {
    return this.moduleCount
}

QRCodeAlg.prototype.isDark = function(row, col) {
    if (row < 0 || this.moduleCount <= row || col < 0 || this.moduleCount <= col) {
        return false
    }
    return this.modules[row][col]
}

// 纠错等级常量
QRCodeAlg.CorrectLevel = {
    L: 1,
    M: 0,
    Q: 3,
    H: 2
}

// 简单的make方法实现（完整实现需要更多代码）
QRCodeAlg.prototype.make = function() {
    // 这里应该包含完整的二维码生成算法
    // 为了简化，我们先实现一个基本版本
    this.typeNumber = 1
    this.moduleCount = this.typeNumber * 4 + 17
    this.modules = []
    
    // 初始化矩阵
    for (var row = 0; row < this.moduleCount; row++) {
        this.modules[row] = []
        for (var col = 0; col < this.moduleCount; col++) {
            this.modules[row][col] = false
        }
    }
    
    // 这里应该添加定位图案、对齐图案、时序图案等
    // 以及数据编码和纠错码
    
    // 简单的测试图案
    for (var row = 0; row < this.moduleCount; row++) {
        for (var col = 0; col < this.moduleCount; col++) {
            this.modules[row][col] = (row + col) % 3 === 0
        }
    }
}

// 创建画布
function createCanvas(width, height) {
    // 这里可以添加创建画布的逻辑
    return null
}

// 导出QRCode对象
export default QRCode